# Copyright 2017-2020 Authors of Cilium
# SPDX-License-Identifier: Apache-2.0
#
include ../../../Makefile.defs
include ../../../Makefile.quiet

DEFAULT_OUT := connectivity-check.yaml
HOSTPORT_OUT := connectivity-check-hostport.yaml
SINGLE_OUT := connectivity-check-single-node.yaml
PROXY_OUT := connectivity-check-proxy.yaml

SRC := $(sort $(wildcard *.c))
ALL_TARGETS := $(DEFAULT_OUT) $(HOSTPORT_OUT) $(SINGLE_OUT) $(PROXY_OUT)
#HOSTPORT_SRC := $(filter-out $(ALL_TARGETS), $(SRC))
#DEFAULT_SRC := $(filter-out $(wildcard *-hostport.yaml),$(HOSTPORT_SRC))
#SINGLE_SRC := $(filter-out $(wildcard *-multi-node*.yaml),$(DEFAULT_SRC))
#PROXY_SRC := $(sort $(filter $(wildcard *proxy*.yaml),$(DEFAULT_SRC)) $(wildcard *-fqdn*.yaml) $(wildcard echo-*yaml))

CUE_IMAGE := "docker.io/cuelang/cue:v0.2.2@sha256:2ea932c771212db140c9996c6fff1d236f3f84ae82add914374cee553b6fc60c"
DOCKER_RUN := $(CONTAINER_ENGINE) container run --rm \
	--workdir /src/examples/kubernetes/connectivity-check \
	--volume $(CURDIR)/../../..:/src \
	--user "$(shell id -u):$(shell id -g)" \
  $(CUE_IMAGE)

all: $(ALL_TARGETS)

$(DEFAULT_OUT): *.cue
	@echo '# Automatically generated by Makefile. DO NOT EDIT' > $(DEFAULT_OUT)
	$(DOCKER_RUN) dump > $(DEFAULT_OUT)

$(HOSTPORT_OUT): *.cue
	@echo '# Automatically generated by Makefile. DO NOT EDIT' > $(HOSTPORT_OUT)
	$(DOCKER_RUN) -t component=all dump > $(DEFAULT_OUT)

$(SINGLE_OUT): *.cue
	@echo '# Automatically generated by Makefile. DO NOT EDIT' > $(SINGLE_OUT)
	$(DOCKER_RUN) -t topology=intra-node dump > $(DEFAULT_OUT)

$(PROXY_OUT): *.cue
	@echo '# Automatically generated by Makefile. DO NOT EDIT' > $(PROXY_OUT)
	$(DOCKER_RUN) -t component=proxy dump > $(DEFAULT_OUT)

clean:
	@rm -f $(ALL_TARGETS)

help:
	$(DOCKER_RUN) cmd help

list:
	$(DOCKER_RUN) cmd ls

eval:
	$(DOCKER_RUN) eval -c ./...

.PHONY: all clean help list eval
